<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Wallet Chile</title>
    <meta name="author" content="Miguel Gonzalez Roblero">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css.css">
</head>
<body>

    <div class="container">
        <div class="login-container">
            <div class="login-title">
                <h2>Bienvenido a <span class="logo-chile">Wallet Chile</span></h2>
            </div>
            
            <div id="alert-container"></div>

            <form id="loginForm">
                <div class="mb-3">
                    <label for="email" class="form-label">Correo Electrónico</label>
                    <input type="email" class="form-control" id="email" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Contraseña</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-chile">Ingresar</button>
                    <button type="button" id="btn-register" class="btn btn-chile-secondary">Registrarse</button>
                </div>
            </form>

            <div class="text-center mt-3">
                <a href="#" id="link-recovery" class="text-decoration-none small text-muted">¿Olvidaste tu contraseña?</a>
            </div>
        </div>

        <div id="recovery-container" class="login-container" style="display:none;">
            <div class="login-title">
                <h4>Recuperar Contraseña</h4>
                <p class="text-muted small">Te enviaremos un código SMS de seguridad.</p>
            </div>
            <div class="mb-3">
                <label for="recovery-email" class="form-label">Correo registrado</label>
                <input type="email" class="form-control" id="recovery-email" placeholder="nombre@correo.com">
            </div>
            <div id="recovery-step-1">
                <button id="btn-send-sms" class="btn btn-chile w-100">Enviar Código SMS</button>
            </div>
            
            <div id="recovery-step-2" style="display:none;">
                <div class="mb-3 mt-3">
                    <label for="sms-code" class="form-label">Código de Verificación</label>
                    <input type="text" class="form-control text-center fs-4" id="recovery-code" placeholder="------" maxlength="6">
                </div>
                <button id="btn-confirm-reset" class="btn btn-success w-100">Verificar y Restablecer</button>
            </div>

            <button id="btn-back-login" class="btn btn-link w-100 mt-3 text-secondary">Volver al Login</button>
        </div>
        <div class="text-end mt-4 text-muted">
            <small>Desarrollado por Miguel Gonzalez Roblero</small>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBPJggK1Xp_jZKi9pqrfMf7gNJbs_-VDZA",
            authDomain: "wallet-73c9f.firebaseapp.com",
            projectId: "wallet-73c9f",
            storageBucket: "wallet-73c9f.firebasestorage.app",
            messagingSenderId: "23318227394",
            appId: "1:23318227394:web:78cbc442708b8b55f68e5b",
            measurementId: "G-KW76JRTY3V"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        $(document).ready(function() {
            let generatedRecoveryCode = null;

            async function handleAuth(isRegister) {
                const email = $('#email').val();
                const password = $('#password').val();

                try {
                    if (isRegister) {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;

                        await setDoc(doc(db, "users", user.uid), {
                            email: email,
                            createdAt: new Date().toISOString()
                        });
                        
                        alert("Usuario creado exitosamente. Ahora serás redirigido.");
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                    
                    $('#alert-container').html(`
                        <div class="alert alert-success">¡Bienvenido! Redirigiendo...</div>
                    `);
                    setTimeout(() => window.location.href = 'menu.html', 1000);

                } catch (error) {
                    console.error(error);
                    let msg = "Error de autenticación: " + error.message;
                    if (error.code === 'auth/invalid-credential') msg = "Correo o contraseña incorrectos.";
                    if (error.code === 'auth/email-already-in-use') msg = "Este correo ya está registrado.";
                    if (error.code === 'auth/weak-password') msg = "La contraseña debe tener al menos 6 caracteres.";
                    if (error.code === 'auth/configuration-not-found') msg = "Error de Configuración: Debes habilitar 'Correo/Contraseña' en la consola de Firebase (Authentication > Sign-in method).";
                    
                    $('#alert-container').html(`<div class="alert alert-danger">${msg}</div>`);
                }
            }

            $('#loginForm').submit(function(e) {
                e.preventDefault();
                handleAuth(false);
            });

            $('#btn-register').click(function() {
                if($('#loginForm')[0].checkValidity()) {
                    handleAuth(true);
                } else {
                    $('#loginForm')[0].reportValidity();
                }
            });

            $('#link-recovery').click(function(e) {
                e.preventDefault();
                $('.login-container').first().slideUp();
                $('#recovery-container').slideDown();
                $('#recovery-email').val($('#email').val());
            });

            $('#btn-back-login').click(function() {
                $('#recovery-container').slideUp();
                $('.login-container').first().slideDown();
                $('#recovery-step-2').hide();
                $('#recovery-step-1').show();
                $('#recovery-code').val('');
            });

            $('#btn-send-sms').click(function() {
                const email = $('#recovery-email').val();
                if (!email) {
                    alert("Por favor ingresa tu correo electrónico.");
                    return;
                }

                generatedRecoveryCode = Math.floor(100000 + Math.random() * 900000);
                alert(`SIMULACIÓN SMS: Tu código de recuperación es ${generatedRecoveryCode}`);
                
                $('#recovery-step-1').slideUp();
                $('#recovery-step-2').slideDown();
            });

            $('#btn-confirm-reset').click(async function() {
                const inputCode = $('#recovery-code').val();
                const email = $('#recovery-email').val();

                if (inputCode == generatedRecoveryCode) {
                    try {
                        await sendPasswordResetEmail(auth, email);
                        alert("¡Código verificado!\n\nSe ha enviado un enlace a tu correo (" + email + ") para que puedas crear tu nueva contraseña de forma segura en Firebase.");
                        $('#btn-back-login').click();
                    } catch (error) {
                        console.error(error);
                        alert("Error al enviar el correo de restablecimiento: " + error.message);
                    }
                } else {
                    alert("Código incorrecto. Inténtalo nuevamente.");
                }
            });
        });
    </script>
</body>
</html>