<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Men√∫ Principal - Wallet Chile</title>
    <meta name="author" content="Miguel Gonzalez Roblero">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css.css">
</head>
<body>

    <div class="chile-header d-flex justify-content-between align-items-center">
        <h4 class="m-0">Men√∫ Principal</h4>
        <button id="btn-logout" class="btn btn-sm btn-outline-light">Salir</button>
    </div>

    <div class="container mt-3 mb-3">
        <div class="text-center mb-3">
            <p class="text-muted mb-0">Saldo Cuenta Corriente</p>
            <h1 id="menu-balance" class="display-4 fw-bold" style="color: var(--color-chile-blue);">$0</h1>
            <p class="text-muted small">N¬∞ Cuenta: 00-123456-7</p>
        </div>

        <div class="row g-2">
            <div class="col-4">
                <div class="bg-white p-2 rounded shadow-sm text-center h-100" style="border-bottom: 3px solid var(--color-success); cursor: pointer;" onclick="window.location.href='credit_line.html'">
                    <small class="text-muted d-block" style="font-size: 0.75rem;">L√≠nea Cr√©dito</small>
                    <div class="fw-bold small">$1.000.000</div>
                </div>
            </div>
            <div class="col-4">
                <div class="bg-white p-2 rounded shadow-sm text-center h-100" style="border-bottom: 3px solid var(--color-chile-blue); cursor: pointer;" onclick="window.location.href='credit_card.html'">
                    <small class="text-muted d-block" style="font-size: 0.75rem;">TC Nacional</small>
                    <div class="fw-bold small">$1.354.010</div>
                </div>
            </div>
            <div class="col-4">
                <div class="bg-white p-2 rounded shadow-sm text-center h-100" style="border-bottom: 3px solid var(--color-chile-blue); cursor: pointer;" onclick="window.location.href='credit_card.html'">
                    <small class="text-muted d-block" style="font-size: 0.75rem;">TC D√≥lares</small>
                    <div class="fw-bold small">US$ 1.879,50</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row g-2">
            <div class="col-6 col-md-4">
                <div class="card text-center h-100 shadow-sm">
                    <div class="card-body p-2">
                        <h6 class="card-title">üí∞ Depositar</h6>
                        <p class="card-text small text-muted mb-2 d-none d-sm-block">Agrega fondos.</p>
                        <button id="btn-deposit" class="btn btn-chile w-100 btn-sm menu-btn" data-target="deposit.html" data-name="Dep√≥sito">Ir</button>
                        <div class="msg-container"></div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-4">
                <div class="card text-center h-100 shadow-sm">
                    <div class="card-body p-2">
                        <h6 class="card-title">üí∏ Transferir</h6>
                        <p class="card-text small text-muted mb-2 d-none d-sm-block">A contactos.</p>
                        <button id="btn-send" class="btn btn-chile w-100 btn-sm menu-btn" data-target="sendmoney.html" data-name="Enviar Dinero">Ir</button>
                        <div class="msg-container"></div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-4">
                <div class="card text-center h-100 shadow-sm">
                    <div class="card-body p-2">
                        <h6 class="card-title">üìä Movimientos</h6>
                        <p class="card-text small text-muted mb-2 d-none d-sm-block">Historial.</p>
                        <button id="btn-transactions" class="btn btn-chile w-100 btn-sm menu-btn" data-target="transactions.html" data-name="√öltimos Movimientos">Ver</button>
                        <div class="msg-container"></div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-4">
                <div class="card text-center h-100 shadow-sm">
                    <div class="card-body p-2">
                        <h6 class="card-title">üè¶ L√≠nea Cr√©dito</h6>
                        <p class="card-text small text-muted mb-2 d-none d-sm-block">Tu cupo.</p>
                        <button id="btn-credit" class="btn btn-chile w-100 btn-sm menu-btn" data-target="credit_line.html" data-name="L√≠nea de Cr√©dito">Ir</button>
                        <div class="msg-container"></div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-4">
                <div class="card text-center h-100 shadow-sm">
                    <div class="card-body p-2">
                        <h6 class="card-title">üßæ Servicios</h6>
                        <p class="card-text small text-muted mb-2 d-none d-sm-block">Cuentas y PAC.</p>
                        <button id="btn-services" class="btn btn-chile w-100 btn-sm menu-btn" data-target="service_payment.html" data-name="Pago de Servicios">Ir</button>
                        <div class="msg-container"></div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-4">
                <div class="card text-center h-100 shadow-sm">
                    <div class="card-body p-2">
                        <h6 class="card-title">üí≥ Tarjeta de credito</h6>
                        <p class="card-text small text-muted mb-2 d-none d-sm-block">Cupo Nac/Int.</p>
                        <button id="btn-credit-card" class="btn btn-chile w-100 btn-sm menu-btn" data-target="credit_card.html" data-name="Tarjeta de Cr√©dito">Ver</button>
                        <div class="msg-container"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="text-end mt-4 mb-4 text-muted">
            <small>Desarrollado por Miguel Gonzalez Roblero</small>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBPJggK1Xp_jZKi9pqrfMf7gNJbs_-VDZA",
            authDomain: "wallet-73c9f.firebaseapp.com",
            projectId: "wallet-73c9f",
            storageBucket: "wallet-73c9f.firebasestorage.app",
            messagingSenderId: "23318227394",
            appId: "1:23318227394:web:78cbc442708b8b55f68e5b",
            measurementId: "G-KW76JRTY3V"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        $(document).ready(function() {
        
            let cachedBalance = localStorage.getItem('walletBalance');
            if (cachedBalance) {
                $('#menu-balance').text('$' + parseInt(cachedBalance).toLocaleString('es-CL'));
            }

            const INACTIVITY_LIMIT = 5 * 60 * 1000;
            let inactivityTimer;

            function resetInactivityTimer() {
                clearTimeout(inactivityTimer);
                inactivityTimer = setTimeout(() => {
                    alert("Tu sesi√≥n ha expirado por inactividad.");
                    signOut(auth).then(() => window.location.href = 'login.html');
                }, INACTIVITY_LIMIT);
            }

            ['mousemove', 'keypress', 'click', 'scroll', 'touchstart'].forEach(evt => document.addEventListener(evt, resetInactivityTimer));
            resetInactivityTimer();

            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    window.location.href = 'login.html';
                } else {
                    console.log("Usuario logueado:", user.email);
                    await calcularSaldoFirebase(user.uid);
                }
            });

            async function calcularSaldoFirebase(userId) {
                try {
                    const q = query(collection(db, "transactions"), where("userId", "==", userId));
                    const querySnapshot = await getDocs(q);
                    let saldoCalculado = 0;

                    querySnapshot.forEach((doc) => {
                        const t = doc.data();
                        const amount = parseInt(t.amount) || 0;
                        
                        if (t.type === 'deposit') {
                            saldoCalculado += amount;
                        } else {
                            saldoCalculado -= amount;
                        }
                    });

                    $('#menu-balance').text('$' + saldoCalculado.toLocaleString('es-CL'));
                    
                    localStorage.setItem('walletBalance', saldoCalculado);
                } catch (error) {
                    console.error("Error calculando saldo:", error);
                }
            }

            $('.menu-btn').click(function() {
                const targetUrl = $(this).data('target');
                const screenName = $(this).data('name');
                const msgContainer = $(this).siblings('.msg-container');

        
                msgContainer.html(`<p class="redirect-msg">Redirigiendo a ${screenName}...</p>`);

                setTimeout(function() {
                    window.location.href = targetUrl;
                }, 1000);
            });

            $('#btn-logout').click(function() {
                signOut(auth).then(() => {
                    window.location.href = 'login.html';
                });
            });
        });
    </script>
</body>
</html>