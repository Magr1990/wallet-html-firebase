<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movimientos - Wallet Chile</title>
    <meta name="author" content="Miguel Gonzalez Roblero">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css.css">
</head>
<body>

    <div class="chile-header">
        <h4 class="m-0">Últimos Movimientos</h4>
    </div>

    <div class="container mt-4">
        
        <div class="mb-4">
            <label for="filter-type" class="form-label">Filtrar por tipo:</label>
            <select id="filter-type" class="form-select">
                <option value="all">Todos</option>
                <option value="deposit">Depósitos</option>
                <option value="purchase">Compras</option>
                <option value="atm">Retiro ATM</option>
                <option value="transfer">Transferencias</option>
                <option value="credit_payment">Pagos Línea Crédito</option>
            </select>
        </div>

        <div id="transactions-list">
        </div>

        <div class="mt-3">
            <a href="menu.html" class="btn btn-link text-secondary">Volver al menú</a>
        </div>
        <div class="text-end mt-3 mb-4 text-muted">
            <small>Desarrollado por Miguel Gonzalez Roblero</small>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBPJggK1Xp_jZKi9pqrfMf7gNJbs_-VDZA",
            authDomain: "wallet-73c9f.firebaseapp.com",
            projectId: "wallet-73c9f",
            storageBucket: "wallet-73c9f.firebasestorage.app",
            messagingSenderId: "23318227394",
            appId: "1:23318227394:web:78cbc442708b8b55f68e5b",
            measurementId: "G-KW76JRTY3V"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        $(document).ready(function() {
            let listaTransacciones = [];

            const INACTIVITY_LIMIT = 5 * 60 * 1000;
            let inactivityTimer;

            function resetInactivityTimer() {
                clearTimeout(inactivityTimer);
                inactivityTimer = setTimeout(() => {
                    alert("Tu sesión ha expirado por inactividad.");
                    signOut(auth).then(() => window.location.href = 'login.html');
                }, INACTIVITY_LIMIT);
            }

            ['mousemove', 'keypress', 'click', 'scroll', 'touchstart'].forEach(evt => document.addEventListener(evt, resetInactivityTimer));
            resetInactivityTimer();

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    await cargarMovimientos(user.uid);
                } else {
                    window.location.href = 'login.html';
                }
            });

            async function cargarMovimientos(userId) {
                const q = query(collection(db, "transactions"), where("userId", "==", userId));
                
                try {
                    const querySnapshot = await getDocs(q);
                    listaTransacciones = [];
                    querySnapshot.forEach((doc) => {
                        listaTransacciones.push(doc.data());
                    });
                    
                    listaTransacciones.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    mostrarUltimosMovimientos('all');
                } catch (e) {
                    console.error("Error cargando movimientos:", e);
                    $('#transactions-list').html('<div class="alert alert-danger">Error cargando datos. Revisa la consola.</div>');
                }
            }

            function formatearFecha(isoString) {
                if (!isoString) return '';
                if (isoString.length === 10) return isoString;
                
                const fecha = new Date(isoString);
                return fecha.toLocaleString('es-CL', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
            }

            function getTipoTransaccion(tipo) {
                switch(tipo) {
                    case 'deposit': return 'Depósito';
                    case 'withdrawal': return 'Compra';
                    case 'purchase': return 'Compra';
                    case 'atm': return 'Retiro ATM';
                    case 'transfer': return 'Transferencia';
                    case 'credit_payment': return 'Pago de Deuda';
                    default: return 'Movimiento';
                }
            }

            function mostrarUltimosMovimientos(filtro) {
                const container = $('#transactions-list');
                container.empty();

                const filtrados = listaTransacciones.filter(t => {
                    if (filtro === 'all') return true;
                    if (filtro === 'purchase') return t.type === 'purchase' || t.type === 'withdrawal';
                    if (filtro === 'atm') return t.type === 'atm';
                    return t.type === filtro;
                });

                if (filtrados.length === 0) {
                    container.html('<div class="alert alert-info">No hay movimientos para este filtro.</div>');
                    return;
                }

                filtrados.forEach(t => {
                    let cssClass = 'transaction-item';
                    
                    let isNegative = t.type === 'withdrawal' || t.type === 'credit_payment' || t.type === 'purchase' || t.type === 'atm';
                    
                    if (t.type === 'transfer' && t.desc && t.desc.startsWith('Envío a')) {
                        isNegative = true;
                    }

                    if (!isNegative) {
                        cssClass += ' transaction-deposit';
                    } else {
                        cssClass += ' transaction-withdrawal';
                    }

                    const html = `
                        <div class="${cssClass} shadow-sm">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="mb-1">${t.desc}</h6>
                                    <small class="text-muted">${getTipoTransaccion(t.type)} - ${formatearFecha(t.date)}</small>
                                </div>
                                <div class="fw-bold ${isNegative ? 'text-danger-custom' : 'text-success-custom'}">
                                    ${isNegative ? '-' : '+'}$${t.amount.toLocaleString('es-CL')}
                                </div>
                            </div>
                        </div>
                    `;
                    container.append(html);
                });
            }

            mostrarUltimosMovimientos('all');

            $('#filter-type').change(function() {
                const seleccion = $(this).val();
                mostrarUltimosMovimientos(seleccion);
            });
        });
    </script>
</body>
</html>